/* (c) 2022 Mega Forms - https://wpmegaforms.com */
!function(u){let e=u(".mf-upload"),c={},g={},_={};u.fn.mfUpload=function(i,n){let o=u(this).closest(".mf_input_file"),p=u(o).siblings(".mf_files_pending"),f=u(o).siblings(".mf_files_completed"),e=u(o).closest("form"),d=u(e).find('[name="_mf_form_id"]').val(),m={settings:{multipleFiles:!1,maxCount:0,maxSize:0,supportedTypes:""},errors:[],pendingFiles:[],pendingFile:null,completedFiles:[],open:()=>{if(u(this).attr("multiple")){m.settings.multipleFiles=!0;m.settings.maxCount=u(this).attr("data-max-count")||0}m.settings.maxSize=u(this).attr("data-max-size")||0;m.settings.supportedTypes=u(this).attr("data-types")||u(this).attr("accept");m.settings.supportedTypes=m.settings.supportedTypes.startsWith("{")?JSON.parse(m.settings.supportedTypes):m.settings.supportedTypes;d in c||(c[d]=[]);d in g||(g[d]=[]);d in _||(_[d]=[]);u(o).find(".mf_notice").remove();m.settings.multipleFiles?m.validateMultiple():m.validateFile(n[0])},validateMultiple:()=>{var t=c[d].filter(e=>null!==e).length+u(f).find("span").length;for(let e=0;e<n.length;e++){if(!(t+m.pendingFiles.length<parseInt(m.settings.maxCount)||0===parseInt(m.settings.maxCount)))return m.errors.push(mfield_file_vars.max_reached),!1;m.validateFile(n[e])}},validateFile:e=>{let t=!1,n=!1,i=e.name,s=e.type,l=e.size,a=parseInt(m.settings.maxSize),r=i.split(".").pop().toLowerCase(),o="";"object"==typeof m.settings.supportedTypes?(!1!==Object.values(m.settings.supportedTypes).includes(s)||0<Object.keys(m.settings.supportedTypes).filter(e=>e.includes(r)).length)&&(t=!0):t=m.settings.supportedTypes.includes("."+r);0<a&&l<a&&(n=!0);t||n?t?n||(o=mfield_file_vars.file_exceeds_limit):o="object"==typeof m.settings.supportedTypes?mfield_file_vars.illegal_extension:mfield_file_vars.invalid_file_extension+m.settings.supportedTypes:o=mfield_file_vars.invalid_size_and_type;""!==o?m.errors.push(i+" - "+o):m.settings.multipleFiles?m.pendingFiles.push(e):m.pendingFile=e},generateErrorsHTML:(e=!1)=>{let t="";if(0<m.errors.length){e||(t+='<span class="mf-notice-holder mf_notice">');for(let e=0;e<m.errors.length;e++)t=(t+="<bdi>")+m.errors[e]+"</bdi>";e||(t+="<span>")}return t},generateCompletedFileHTML:e=>{let t="",n=u(o).find('input[type="file"]').attr("name");if(void 0!==c[d][e]){var i=m.completedFiles[e].size/1024,i=parseFloat(i).toFixed(2);t=(t=(t=(t=(t=t+('<span class="completed" data-id="'+m.completedFiles[e].hash+'">')+'<i class="mf-delete-file mega-icons-clear"></i>')+("<strong>"+m.completedFiles[e].name+" </strong>"))+(1024<i?" ("+parseFloat(i/1024).toFixed(2)+" mb)":" ("+i+" kb)"))+('<input type="hidden" name="'+n+"[files]["+m.completedFiles[e].hash+'][name]" value="'+m.completedFiles[e].name+'">'))+('<input type="hidden" name="'+n+"[files]["+m.completedFiles[e].hash+'][size]" value="'+m.completedFiles[e].size+'">')+"</span>"}return t},generatePendingFileHTML:(t,n=!1)=>{let i="";if(void 0!==c[d][t]&&null!==c[d]){let e=c[d][t].size/1024;e=1<e?parseInt(e):parseFloat(e).toFixed(2);i=(i=(i+='<span data-id="'+t+'">')+c[d][t].name)+(" ("+e+" kb)");n&&(i=(i+=' <bdi class="mf_progress">0%</bdi>')+' <a href="#" class="mf-cancel-file"><strong>'+mfield_file_vars.cancel+"</strong></a>");i+="</span>"}return i},uploadFiles:n=>{var s=u(o).closest(".mfield").attr("data-id"),l=u(e).find('[name="_mf_referrer"]').val(),a=u(e).find('[name="_mf_nonce"]').val(),r=u(e).find('[name="_mf_extra_nonce"]').val();for(let t=0;n.length>t;t++){let i=n[t],e=(g[d].push(i),new FormData);e.append("type","upload");e.append("file",c[d][i]);e.append("_mf_field_id",s);e.append("_mf_form_id",d);e.append("_mf_referrer",l);e.append("_mf_nonce",a);e.append("_mf_extra_nonce",r);e.append("action","megaforms_file_handler");_[d][i]=jQuery.ajax({type:"POST",url:megaForms.ajaxurl,data:e,contentType:!1,processData:!1,xhr:function(){var e=u.ajaxSettings.xhr();e.upload.addEventListener("progress",function(e){if(e.lengthComputable){e=e.loaded/e.total*100;m.setProgressPercentage(i,e-1)}},!1);return e},beforeSend:function(){u(p).append(m.generatePendingFileHTML(i,!0))},success:e=>{e=JSON.parse(e);if(e.success){m.completedFiles[i]=e.data;u(f).append(m.generateCompletedFileHTML(i))}else{m.errors.push(c[d][i].name+" - "+e.message);m.updateErrors(!0)}m.clearPendingFile(i,!1);return!0},error:(e,t,n)=>{if("abort"!==t){console.log("XHR ERROR "+e.status+": "+n||t);m.errors.push(c[d][i].name+" - "+mfield_file_vars.unknown_error);m.updateErrors(!0);m.clearPendingFile(i,!1)}else m.clearPendingFile(i,!0);return!1}})}},clearPendingFile:(e,t=!0)=>{var n=u(p).find('[data-id="'+e+'"]');t?u(n).fadeOut(300,function(){u(this).remove()}):u(n).remove();c[d][e]=null;_[d][e]=null;g[d][g[d].indexOf(e)]=null},setProgressPercentage:(e,t)=>{e=u(p).find('[data-id="'+e+'"] .mf_progress');0<e.length&&u(e).text(parseInt(t)+"%")},updateErrors:(e=!1)=>{if(0<m.errors.length){var t=u(o).find(".mf_notice");if(e&&0<u(t).length)u(t).append(m.generateErrorsHTML(e));else{0<u(t).length&&u(o).find(".mf_notice").remove();u(o).append(m.generateErrorsHTML())}}},close:()=>{(m.settings.multipleFiles&&i.currentTarget.files||!1===m.settings.multipleFiles&&0<m.errors.length)&&(i.currentTarget.value=null);if(m.settings.multipleFiles){let t=[];for(let e=0;e<m.pendingFiles.length;e++){var n=c[d].push(m.pendingFiles[e]);t.push(n-1)}m.uploadFiles(t);u(o).find(".mf-files-count").text(c[d].filter(e=>null!==e).length+u(f).find("span").length)}else{var e=c[d].push(m.pendingFile),t=u(f).find("span");u(p).html(m.generatePendingFileHTML(e-1));if(0<u(t).length){u(t).html(function(e,t){return t.replace("strong>","strike>")});u(t).find(".mf-delete-file").remove()}}m.updateErrors()}};m.open();m.close()};u.fn.mfUploadInit=function(e){u(this).on("change",".mf-upload",function(e){u(this).mfUpload(e,e.currentTarget.files)});if(0<u(".mf_files_dock").length){u(this).on("drag dragstart dragend dragover dragenter dragleave drop",".mf_files_dock",function(e){e.preventDefault(),e.stopPropagation()});u(this).on("dragover",".mf_files_dock",function(e){u(this).addClass("mf_files_dock_hover")});u(this).on("dragleave",".mf_files_dock",function(e){u(this).removeClass("mf_files_dock_hover")});u(this).on("drop",".mf_files_dock",function(e){u(this).removeClass("mf_files_dock_hover");e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length&&u(this).closest(".mf_input_file").find('input[type="file"]').mfUpload(e,e.originalEvent.dataTransfer.files)})}u(this).on("click",".mf-delete-file",function(e){e.preventDefault();u(this).closest("span").mfUploadDelete(e)});u(this).on("click",".mf-cancel-file",function(e){e.preventDefault();var e=u(this),t=parseInt(u(e).closest("span").attr("data-id")),e=u(e).closest("form"),e=parseInt(u(e).find('input[name="_mf_form_id"]').val());void 0!==e&void 0!==t&&void 0!==_[e][t]&&_[e][t].abort("abort")});u(this).on("click",'[type="submit"], .mf-prev-btn',function(t){let n=Object.values(g);if(0<n.length)for(let e=0;n.length>e;e++)if(0<n[e].filter(e=>null!==e).length){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();alert(mfield_file_vars.currently_uploading);return!1}})};u.fn.mfUploadDelete=function(e,t=!0){let n=u(this),i=u(n).closest("form"),s=u(n).attr("data-id"),l=u(i).find('input[name="_mf_form_id"]').val(),a=u(i).find('input[name="_mf_referrer"]').val(),r=u(i).find('input[name="_mf_nonce"]').val(),o=u(i).find('input[name="_mf_extra_nonce"]').val(),p=new FormData;p.append("type","delete");p.append("hash",s);p.append("_mf_form_id",l);p.append("_mf_referrer",a);p.append("_mf_nonce",r);p.append("_mf_extra_nonce",o);p.append("action","megaforms_file_handler");jQuery.ajax({type:"POST",url:megaForms.ajaxurl,data:p,contentType:!1,processData:!1,beforeSend:function(){let e=u(n).closest(".mf_files_completed");if(t)u(n).closest("span").fadeOut(300,function(){u(this).remove();u(e).siblings(".mf_input_file").find(".mf-files-count").text(u(e).find("span").length)});else{u(n).remove();u(e).siblings(".mf_input_file").find(".mf-files-count").text(u(e).find("span").length)}}})};0<e.length&&u(document).mfUploadInit()}(jQuery);